apiVersion: batch/v1
kind: Job
metadata:
  name: ligand-selector
  namespace: drug-pipeline
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      initContainers:
        # データベースファイルを zinc-library PVC にコピー
        - name: init-db
          image: busybox:latest
          command:
            - sh
            - -c
            - |
              mkdir -p /zinc-library/db
              if [ ! -f /zinc-library/db/ocp_results.sqlite ]; then
                echo "[INIT] Copying database from ConfigMap to PVC..."
                cp /db-source/ocp_results.sqlite /zinc-library/db/ocp_results.sqlite
                echo "[INIT] Database copied successfully"
              else
                echo "[INIT] Database already exists, skipping copy"
              fi
          volumeMounts:
            - name: zinc-library
              mountPath: /zinc-library
            - name: db-source
              mountPath: /db-source
      containers:
        - name: ligand-selector
          image: pipeline/ligand-selector:local
          imagePullPolicy: IfNotPresent
          env:
            - name: TARGET_CODE
              valueFrom:
                configMapKeyRef:
                  name: pipeline-config
                  key: targetCode
            - name: LIBRARY_CODE
              valueFrom:
                configMapKeyRef:
                  name: pipeline-config
                  key: libraryCode
            - name: NUM_LIGANDS
              valueFrom:
                configMapKeyRef:
                  name: pipeline-config
                  key: numLigands
            - name: DB_PATH
              value: /zinc-library/db/ocp_results.sqlite
            - name: WORKSPACE
              value: /workspace
          volumeMounts:
            - name: work-pvc
              mountPath: /workspace
            - name: zinc-library
              mountPath: /zinc-library
      volumes:
        - name: work-pvc
          persistentVolumeClaim:
            claimName: work-pvc
        - name: zinc-library
          persistentVolumeClaim:
            claimName: zinc-library-pvc
        - name: db-source
          configMap:
            name: ocp-database
